<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .body_wrap {
            width: 600px;
            height: 600px;
            display: flex;
            flex-direction: column;
            border-radius: 10%;
            align-items: center;

            background-image: url('img/canvas.jpg');
            background-repeat: repeat;
        }
        #titleScreen { margin-top: 100px; }
        #titleScreen h1 {
            font-size: 50px;
            font-weight: 900;
            color:white;
            margin-bottom: 30px;
        }
        #startButton {
            background-color: rgb(104, 64, 4);
            color: white;
            border-radius: 9999px;
            padding: 20px 40px;
            font-weight: 700;
            font-size: 50px;
            border: none;
            outline: none;
            margin-left: 60px;
        }
        .board {
            width: 400px;
            height: 100px;
            display: none;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            margin-top: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            background-color: white;
            border-radius: 9999px;
        }
        #score {
            width: 100%;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .seed {
             display: flex;
             width: 50px;
             height: 50px;
             justify-content: center;
             align-items: center;
        }
        #score .seed img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            position: static;
            gap: 5px
        }
        #timer {
            width: 100%
            color: black;
            font-size: 20px;
            text-align: center;
            font-weight: bold;
            padding-top: 10px;
        }
        #canvas {
            border: 3px solid rgb(237, 203, 139);
            width: 500px;
            height: 500px;
            position: relative;
            border-radius: 10%;
            background-color: white;
            display: none;
        }
        #canvas img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            position: absolute;
            z-index: 1;
        }

        #circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            position: absolute;
            background-color: white;
            border: 0;
            z-index: 2;
        }

        #result {
            display: flex;
            flex-direction: column;
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            align-items: center;
            z-index: 10;

            width:  350px;
            height: 350px;

            margin-left: 150px;
            margin-top: 200px;
        }
        #result > div {
            border: 5px solid rgb(117, 65, 5);
            background-color: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
        }
        #result > div > p {
            font-size: 17px;
            font-weight: 500;
            color: black
        }
        #restartBtn {
            background-color: #d9730d;
            color: white;
            font-weight: 700;
            font-size: 20px;
            border-radius: 9999px;
            border: none;
        }
    </style>
</head>
<body>
<div class="body_wrap">
    <div id="titleScreen">
        <h1>클릭하여 게임시작!</h1>
        <button id="startButton" onclick="startGame()">시작하기</button>
    </div>

    <div class="board">
        <div id="timer"></div>
        <div id="score"></div>
    </div>

    <div id="canvas">
        <div id="circle"><img src='img/hamster.png' alt="player"></div>

        <div id='result'></div>
    </div>
</div>

<script>
    const total = 5; // 도달해야할 목표 개수
    const STEP = 10; // 공이 움직일 이동거리
    const canvasWidth = 500;
    const canvasHeight = 500;
    const currentLeft = 150; // 초기 원의 x 위치
    const currentTop = 150; // 초기 원의 y 위치
    const TIME_LIMIT = 20;
    const ELEMENT_SIZE = 50 // 햄스터, 씨앗 크기

    let currentTime = TIME_LIMIT;
    let isGameOver = false;
    let score = 0;
    let timerInterval;
    let player;
    let goal;

    function startGame() {
        score = 0;
        document.getElementById('titleScreen').style.display = 'none';
        document.querySelector('.board').style.display = 'flex';
        document.getElementById('canvas').style.display = 'block';

        // document.getElementById('canvas').querySelectorAll('img[src*="seed"]').forEach(el => el.remove());

        goal = new Goal();
        player = new Circle(currentLeft, currentTop, goal);

        startTimer();
        player.move();
        board();
    }

    function startTimer() {
        currentTime = TIME_LIMIT;
        if(timerInterval){ clearInterval(timerInterval); } // 이전 타이머는 초기화

        timerInterval = setInterval( () => {  // 게임 종료일 때 타이머 초기화
            if (isGameOver) {
                clearInterval(timerInterval);
                return;
            }

            currentTime--;
            board();

            if(currentTime <= 0){
                clearInterval(timerInterval);
                gameOver("game over!");
            }
        }, 1000);
    }

    function board(){
    const divScore = document.getElementById('score');
      divScore.innerHTML = '';
            for (let i = 1; i <= total; i++) {
                let imageUrl = '';
                if (i <= score) { imageUrl = 'img/seed.png'; }
                else { imageUrl = 'img/seed2.png'; }

                divScore.innerHTML += `<div class="seed"><img src='${imageUrl}'></div>`;
            }

            const divTimer = document.getElementById('timer');
            divTimer.innerHTML = `남은 시간: ${currentTime}초`;
    }

    function gameOver(message) {
        if (isGameOver) return;
        isGameOver = true;
        clearInterval(timerInterval); // 게임이 끝났으므로 타이머 리셋

        const divResult = document.getElementById('result');
        divResult.style.display = 'flex';
        divResult.innerHTML = `<div><p>${message}<br><br>
        <input type='button' id='restartBtn' value='다시하기' onclick='location.reload();'></p></div>`;
    }
    function endGame(score){
        if(score >= total){
            gameOver("게임을 클리어 하셨습니다!");
        }
    }

    function Circle(currentLeft, currentTop, targetGoal){ // 초기 위치
        this.element = document.querySelector("#circle")

        this.x = currentLeft;
        this.y = currentTop;
        this.goal = targetGoal;

        this.element.style.left = `${this.x}px`;
        this.element.style.top = `${this.y}px`;

        this.checkCollisions = function(){
            const size = ELEMENT_SIZE;

            if ( this.x < this.goal.x + size &&  this.x + size > this.goal.x &&
                // 햄스터의 왼쪽이 씨앗 오른쪽에 접촉, 오른쪽이 씨앗 왼쪽에 접촉
                 this.y < this.goal.y + size && this.y + size > this.goal.y ) {
                // 햄스터 위쪽이 씨앗 아래쪽에 접촉, 아래쪽이 씨앗 위쪽에 접촉

                score++;
                this.goal.reset();
                board();
                endGame(score);
                return true;
            }
            return false;
        }

          this.handleKeydown = (event) => {
            if (isGameOver) return;

            event.preventDefault();
            let key = event.key;
            let moved = false;

            let newX = this.x;
            let newY = this.y;

            switch (key) {
                case 'ArrowLeft': newX -= STEP; moved = true; break;
                case 'ArrowRight': newX += STEP; moved = true; break;
                case 'ArrowUp': newY -= STEP; moved = true; break;
                case 'ArrowDown': newY += STEP; moved = true; break;
                default: return;
            }

            // Canvas 경계 확인
            if(newX < 0){ newX = 0; }
            else if(newX > canvasWidth - ELEMENT_SIZE){ newX = canvasWidth - ELEMENT_SIZE; }
            if(newY < 0){ newY = 0; }
            else if(newY > canvasHeight - ELEMENT_SIZE){ newY = canvasHeight - ELEMENT_SIZE; }

            this.x = newX;
            this.y = newY;

            this.element.style.left = `${this.x}px`; // 키를 누른만큼 원의 위치를 갱신
            this.element.style.top = `${this.y}px`;

            if(moved) { this.checkCollisions(); }
          }
          this.move = ()=>{ document.addEventListener('keydown', this.handleKeydown); }
    }


    function position(limit){ return Math.floor(Math.random() * limit)}
    function Goal(){
        const canvasArea = document.querySelector("#canvas")

        this.element = document.createElement("img");
        this.element.setAttribute('src', 'img/seed.png')  // 목표로 삼을 이미지 생성
        canvasArea.appendChild(this.element) // canvas에 img 태그를 집어넣음

        this.x = 0;
        this.y = 0;

        this.reset = function(){
            this.x = position(canvasWidth-50);
            this.y = position(canvasHeight-50);
            this.element.style.left = this.x  + 'px'
            this.element.style.top = this.y + 'px'
        }
        this.reset();
    }

    window.onload = function(){
    board()
    }
</script>
</body>
</html>